name: Release to GitHub Packages

on:
  release:
    types: [created]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Extract version from release tag
        id: extract_version
        run: |
          # Get the tag name from the release (e.g., v1.0.0 or 1.0.0)
          TAG_NAME="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Update version in pom.xml
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          # Use Maven versions plugin to update version
          mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false
          echo "Updated pom.xml to version $VERSION"
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit version bump
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          git add pom.xml
          git commit -m "Bump version to $VERSION" || echo "No changes to commit"
          echo "COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
      
      - name: Build with Maven
        run: mvn -B clean package --file pom.xml
      
      - name: Deploy to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create settings.xml for GitHub Packages authentication
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>\${env.GITHUB_ACTOR}</username>
                <password>\${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
          
          # Deploy to GitHub Packages
          mvn -B deploy -DskipTests
      
      - name: Upload JAR to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./target/lib-version-${{ steps.extract_version.outputs.version }}.jar
          asset_name: lib-version-${{ steps.extract_version.outputs.version }}.jar
          asset_content_type: application/java-archive
      
      - name: Create and push version tag
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          # Get the current branch name
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $BRANCH_NAME"
          
          # Delete the old tag locally and remotely if it exists
          git tag -d "v$VERSION" 2>/dev/null || true
          git push origin :refs/tags/v$VERSION 2>/dev/null || true
          
          # Create new tag pointing to the version bump commit
          git tag -a "v$VERSION" -m "Release version $VERSION"
          
          # Push the commit and tag
          git push origin HEAD:$BRANCH_NAME
          git push origin "v$VERSION"
      
      - name: Update release to point to new commit
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = "${{ steps.extract_version.outputs.version }}";
            const commitSha = process.env.COMMIT_SHA;
            
            // Update the release to point to the new commit
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              tag_name: `v${version}`,
              target_commitish: commitSha
            });
            
            console.log(`Updated release to point to commit ${commitSha}`);
